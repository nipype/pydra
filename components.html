

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dataflows Components: Task and Workflow &mdash; Pydra: A simple dataflow engine with scalable semantics 0.25.dev198+gb207551d documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />

  
      <script src="_static/jquery.js"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
      <script src="_static/doctools.js"></script>
      <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="State and Nested Loops over Input" href="state.html" />
    <link rel="prev" title="User Guide" href="user_guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Pydra: A simple dataflow engine with scalable semantics
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="user_guide.html">User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dataflows Components: Task and Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#function-tasks">Function Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shell-command-tasks">Shell Command Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#container-tasks">Container Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#workflows">Workflows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-s-state">Task’s State</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="state.html">State and Nested Loops over Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="combiner.html">Grouping Task’s Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="input_spec.html">Input Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="output_spec.html">Output Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Library API (application programmer interface)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pydra: A simple dataflow engine with scalable semantics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="user_guide.html">User Guide</a></li>
      <li class="breadcrumb-item active">Dataflows Components: Task and Workflow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/components.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dataflows-components-task-and-workflow">
<h1>Dataflows Components: Task and Workflow<a class="headerlink" href="#dataflows-components-task-and-workflow" title="Permalink to this heading"></a></h1>
<p>A <em>Task</em> is the basic runnable component of <em>Pydra</em> and is described by the
class <code class="docutils literal notranslate"><span class="pre">TaskBase</span></code>. A <em>Task</em> has named inputs and outputs, thus allowing
construction of dataflows. It can be hashed and executes in a specific working
directory. Any <em>Pydra</em>’s <em>Task</em> can be used as a function in a script, thus allowing
dual use in <em>Pydra</em>’s <em>Workflows</em> and in standalone scripts. There are several
classes that inherit from <code class="docutils literal notranslate"><span class="pre">TaskBase</span></code> and each has a different application:</p>
<section id="function-tasks">
<h2>Function Tasks<a class="headerlink" href="#function-tasks" title="Permalink to this heading"></a></h2>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">FunctionTask</span></code> is a <em>Task</em> that executes Python functions. Most Python functions
declared in an existing library, package, or interactively in a terminal can
be converted to a <code class="docutils literal notranslate"><span class="pre">FunctionTask</span></code> by using <em>Pydra</em>’s decorator - <code class="docutils literal notranslate"><span class="pre">mark.task</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra</span><span class="w"> </span><span class="kn">import</span> <span class="n">mark</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">})(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">)</span>
<span class="n">fft_task</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">fft</span><span class="p">)()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">fft_task</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">512</span><span class="p">))</span>
</pre></div>
</div>
<p><cite>fft_task</cite> is now a <em>Pydra</em> <em>Task</em> and result will contain a <em>Pydra</em>’s <code class="docutils literal notranslate"><span class="pre">Result</span></code> object.
In addition, the user can use Python’s function annotation or another <em>Pydra</em>
decorator — <code class="docutils literal notranslate"><span class="pre">mark.annotate</span></code> in order to specify the output. In the
following example, we decorate an arbitrary Python function to create named
outputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">}}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mean_dev</span><span class="p">(</span><span class="n">my_data</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
    <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">my_data</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">my_data</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">mean_dev</span><span class="p">(</span><span class="n">my_data</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])()</span>
</pre></div>
</div>
<p>When the <em>Task</em> is executed <cite>result.output</cite> will contain two attributes: <cite>mean</cite>
and <cite>std</cite>. Named attributes facilitate passing different outputs to
different downstream nodes in a dataflow.</p>
</li>
</ul>
</section>
<section id="shell-command-tasks">
<span id="shell-command-task"></span><h2>Shell Command Tasks<a class="headerlink" href="#shell-command-tasks" title="Permalink to this heading"></a></h2>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ShellCommandTask</span></code> is a <em>Task</em> used to run shell commands and executables.
It can be used with a simple command without any arguments, or with specific
set of arguments and flags, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ShellCommandTask</span><span class="p">(</span><span class="n">executable</span><span class="o">=</span><span class="s2">&quot;pwd&quot;</span><span class="p">)</span>

<span class="n">ShellCommandTask</span><span class="p">(</span><span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s2">&quot;my_dir&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>Task</em> can accommodate more complex shell commands by allowing the user to
customize inputs and outputs of the commands.
One can generate an input
definition to specify names of inputs, positions in the command, types of
the inputs, and other metadata.
As a specific example, FSL’s BET command (Brain
Extraction Tool) can be called on the command line as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bet</span> <span class="n">input_file</span> <span class="n">output_file</span> <span class="o">-</span><span class="n">m</span>
</pre></div>
</div>
<p>Each of the command argument can be treated as a named input to the
<code class="docutils literal notranslate"><span class="pre">ShellCommandTask</span></code>, and can be included in the input definition.
As shown next, even an output is specified by constructing
the <em>out_file</em> field form a template:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bet_input_spec</span> <span class="o">=</span> <span class="n">SpecInfo</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Input&quot;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span> <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span>
      <span class="p">{</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;input file ...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;mandatory&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">}</span> <span class="p">),</span>
    <span class="p">(</span> <span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span>
      <span class="p">{</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;name of output ...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;output_file_template&quot;</span><span class="p">:</span>
                          <span class="s2">&quot;</span><span class="si">{in_file}</span><span class="s2">_br&quot;</span> <span class="p">}</span> <span class="p">),</span>
    <span class="p">(</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span>
      <span class="p">{</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;create binary mask&quot;</span><span class="p">,</span>
        <span class="s2">&quot;argstr&quot;</span><span class="p">:</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="p">}</span> <span class="p">)</span> <span class="p">],</span>
    <span class="n">bases</span><span class="o">=</span><span class="p">(</span><span class="n">ShellDef</span><span class="p">,)</span> <span class="p">)</span>

<span class="n">ShellCommandTask</span><span class="p">(</span><span class="n">executable</span><span class="o">=</span><span class="s2">&quot;bet&quot;</span><span class="p">,</span>
                 <span class="n">input_spec</span><span class="o">=</span><span class="n">bet_input_spec</span><span class="p">)</span>
</pre></div>
</div>
<p>More details are in the <a class="reference internal" href="input_spec.html#input-specification-section"><span class="std std-ref">Input Specification</span></a>.</p>
</li>
</ul>
</section>
<section id="container-tasks">
<h2>Container Tasks<a class="headerlink" href="#container-tasks" title="Permalink to this heading"></a></h2>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ContainerTask</span></code> class is a child class of <code class="docutils literal notranslate"><span class="pre">ShellCommandTask</span></code> and serves as
a parent class for <code class="docutils literal notranslate"><span class="pre">DockerTask</span></code> and <code class="docutils literal notranslate"><span class="pre">SingularityTask</span></code>. Both <em>Container Tasks</em>
run shell commands or executables within containers with specific user defined
environments using <a class="reference external" href="https://www.docker.com/">Docker</a> and <a class="reference external" href="https://www.singularity.lbl.gov/">Singularity</a> software respectively.
This might be extremely useful for users and projects that require environment
encapsulation and sharing.
Using container technologies helps improve scientific
workflows reproducibility, one of the key concept behind <em>Pydra</em>.</p>
<p>These <em>Container Tasks</em> can be defined by using
<code class="docutils literal notranslate"><span class="pre">DockerTask</span></code> and <code class="docutils literal notranslate"><span class="pre">SingularityTask</span></code> classes directly, or can be created
automatically from <code class="docutils literal notranslate"><span class="pre">ShellCommandTask</span></code>, when an optional argument
<code class="docutils literal notranslate"><span class="pre">container_info</span></code> is used when creating a <em>Shell Task</em>. The following two
types of syntax are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DockerTask</span><span class="p">(</span><span class="n">executable</span><span class="o">=</span><span class="s2">&quot;pwd&quot;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s2">&quot;busybox&quot;</span><span class="p">)</span>

<span class="n">ShellCommandTask</span><span class="p">(</span><span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span>
     <span class="n">container_info</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;busybox&quot;</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="workflows">
<h2>Workflows<a class="headerlink" href="#workflows" title="Permalink to this heading"></a></h2>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Workflow</span></code> - is a subclass of <em>Task</em> that provides support for creating <em>Pydra</em>
dataflows. As a subclass, a <em>Workflow</em> acts like a <em>Task</em> and has inputs, outputs,
is hashable, and is treated as a single unit. Unlike <em>Tasks</em>, workflows embed
a directed acyclic graph. Each node of the graph contains a <em>Task</em> of any type,
including another <em>Workflow</em>, and can be added to the <em>Workflow</em> simply by calling
the <code class="docutils literal notranslate"><span class="pre">add</span></code> method. The connections between <em>Tasks</em> are defined by using so
called <em>Lazy Inputs</em> or <em>Lazy Outputs</em>. These are special attributes that allow
assignment of values when a <em>Workflow</em> is executed rather than at the point of
assignment. The following example creates a <em>Workflow</em> from two <em>Pydra</em> <em>Tasks</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># creating workflow with two input fields</span>
<span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">input_spec</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
<span class="c1"># adding a task and connecting task&#39;s input</span>
<span class="c1"># to the workflow input</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mlt&quot;</span><span class="p">,</span>
               <span class="n">x</span><span class="o">=</span><span class="n">wf</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">wf</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
<span class="c1"># adding another task and connecting</span>
<span class="c1"># task&#39;s input to the &quot;mult&quot; task&#39;s output</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">add2</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wf</span><span class="o">.</span><span class="n">mlt</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">out</span><span class="p">))</span>
<span class="c1"># setting workflow output</span>
<span class="n">wf</span><span class="o">.</span><span class="n">set_output</span><span class="p">([(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">out</span><span class="p">)])</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="task-s-state">
<h2>Task’s State<a class="headerlink" href="#task-s-state" title="Permalink to this heading"></a></h2>
<p>All Tasks, including Workflows, can have an optional attribute representing an instance of the State class.
This attribute controls the execution of a Task over different input parameter sets.
This class is at the heart of Pydra’s powerful Map-Reduce over arbitrary inputs of nested dataflows feature.
The State class formalizes how users can specify arbitrary combinations.
Its functionality is used to create and track different combinations of input parameters,
and optionally allow limited or complete recombinations.
In order to specify how the inputs should be split into parameter sets, and optionally combined after
the Task execution, the user can set splitter and combiner attributes of the State class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">task_with_state</span> <span class="o">=</span>
      <span class="n">add2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">State</span></code> class is responsible for creating a list of two
separate inputs, <em>[{x: 1}, {x:5}]</em>, each run of the <em>Task</em> should get one
element from the list. Note that in this case the value for <cite>x</cite> is set in the <cite>split()</cite>
method, not at the task’s initialisation.
The <cite>combine()</cite> method, specifies that the results are grouped back when returning the
result from the <em>Task</em>.</p>
<p>While this example illustrates mapping and grouping of results over a single parameter,
<em>Pydra</em> extends this to arbitrary combinations of input fields and downstream grouping
over nested dataflows. Details of how splitters and combiners power <em>Pydra</em>’s
scalable dataflows are described in the next section.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user_guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="state.html" class="btn btn-neutral float-right" title="State and Nested Loops over Input" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2020, The Nipype Developers team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>