<!doctype html>
<html class="no-js" lang="English" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 6.2.1 and Furo 2024.08.06 -->
        <title>pydra.engine.specs - Pydra v0.25</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=04c057b233f3c8d71940eee6080f658a04e2027d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=cf727022eb7470bc603c08d2e55c3247faec75c9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  --color-brand-primary: #69306d;
  --color-brand-content: #69306d;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #111111;
  --color-code-foreground: #ffffff;
  --color-brand-primary: #ce8dcf;
  --color-brand-content: #ce8dcf;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #111111;
  --color-code-foreground: #ffffff;
  --color-brand-primary: #ce8dcf;
  --color-brand-content: #ce8dcf;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Pydra v0.25</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/pydra_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Pydra v0.25</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Tutorials: Execution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/1-getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/2-advanced-execution.html">Advanced execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/3-troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials: Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/4-python.html">Python-tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/5-shell.html">Shell-tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/6-workflow.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/7-canonical-form.html">Canonical task form</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/t1w-preprocess.html">T1w MRI preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/first-level-glm.html">One-Level GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/two-level-glm.html">Two-Level GLM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/create-task-package.html">Create a task package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/port-from-nipype.html">Port interfaces from Nipype</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/design-approach.html">Design philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/splitting-combining.html">Splitting and combining</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/conditional-lazy.html">Dynamic construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/environments.html">Software environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/hashing-caching.html">Caches and hashes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/typing.html">Typing and file-formats</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pydra.engine.specs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Task I/O definitions.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">attrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cloudpickle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fileformats.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.utils.messenger</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuditFlag</span><span class="p">,</span> <span class="n">Messenger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.utils.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">attrs_fields</span><span class="p">,</span>
    <span class="n">attrs_values</span><span class="p">,</span>
    <span class="n">is_lazy</span><span class="p">,</span>
    <span class="n">list_fields</span><span class="p">,</span>
    <span class="n">position_sort</span><span class="p">,</span>
    <span class="n">ensure_list</span><span class="p">,</span>
    <span class="n">parse_format_string</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.helpers_file</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_update</span><span class="p">,</span> <span class="n">template_update_single</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">helpers_state</span> <span class="k">as</span> <span class="n">hlpst</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">lazy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.utils.hash</span><span class="w"> </span><span class="kn">import</span> <span class="n">hash_function</span><span class="p">,</span> <span class="n">Cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.utils.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateArray</span><span class="p">,</span> <span class="n">MultiInputObj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.design.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Arg</span><span class="p">,</span> <span class="n">Out</span><span class="p">,</span> <span class="n">RequirementSet</span><span class="p">,</span> <span class="n">EMPTY</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.design</span><span class="w"> </span><span class="kn">import</span> <span class="n">shell</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.lazy</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyInField</span><span class="p">,</span> <span class="n">LazyOutField</span>

<span class="k">if</span> <span class="n">ty</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiGraph</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.submitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeExecution</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Workflow</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateIndex</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.environments</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.workers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Worker</span>


<span class="n">DefType</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;DefType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;TaskDef&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="is_set"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.is_set">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">is_set</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a value has been set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">NOTHING</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">)</span></div>


<div class="viewcode-block" id="TaskOutputs"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskOutputs">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TaskOutputs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all output definitions&quot;&quot;&quot;</span>

    <span class="n">RESERVED_FIELD_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The inputs object associated with a lazy-outputs object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node</span><span class="p">()</span><span class="o">.</span><span class="n">inputs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_defaults</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an output object from the default values of the fields&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">factory</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">Factory</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">default</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">attrs_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> outputs object is not a lazy output of a workflow node&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The names of the fields in the output object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">attrs_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_index</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the value for the given attribute</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            the name of the attribute to return</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            the value of the attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="n">name_or_index</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> doesn&#39;t have an attribute </span><span class="si">{</span><span class="n">name_or_index</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if two task definitions are equal&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_values</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_fields</span> <span class="o">=</span> <span class="n">list_fields</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="o">!=</span> <span class="n">other_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">hash_eq</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">other_values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">other_values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">values</span> <span class="o">==</span> <span class="n">other_values</span></div>


<span class="n">OutputsType</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;OutputType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">TaskOutputs</span><span class="p">)</span>


<div class="viewcode-block" id="TaskDef"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskDef">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TaskDef</span><span class="p">(</span><span class="n">ty</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">OutputsType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all task definitions&quot;&quot;&quot;</span>

    <span class="c1"># The following fields are used to store split/combine state information</span>
    <span class="n">_splitter</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_combiner</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_cont_dim</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_hashes</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">RESERVED_FIELD_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;combine&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">worker</span><span class="p">:</span> <span class="s2">&quot;str | ty.Type[Worker] | Worker&quot;</span> <span class="o">=</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;Environment | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rerun</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cache_locations</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">audit_flags</span><span class="p">:</span> <span class="n">AuditFlag</span> <span class="o">=</span> <span class="n">AuditFlag</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">messengers</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Messenger</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">messenger_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputsType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a task from this definition and execute it to produce a result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cache_dir : os.PathLike, optional</span>
<span class="sd">            Cache directory where the working directory/results for the task will be</span>
<span class="sd">            stored, by default None</span>
<span class="sd">        worker : str or Worker, optional</span>
<span class="sd">            The worker to use, by default &quot;cf&quot;</span>
<span class="sd">        environment: Environment, optional</span>
<span class="sd">            The execution environment to use, by default None</span>
<span class="sd">        rerun : bool, optional</span>
<span class="sd">            Whether to force the re-computation of the task results even if existing</span>
<span class="sd">            results are found, by default False</span>
<span class="sd">        cache_locations : list[os.PathLike], optional</span>
<span class="sd">            Alternate cache locations to check for pre-computed results, by default None</span>
<span class="sd">        audit_flags : AuditFlag, optional</span>
<span class="sd">            Auditing configuration, by default AuditFlag.NONE</span>
<span class="sd">        messengers : list, optional</span>
<span class="sd">            Messengers, by default None</span>
<span class="sd">        messenger_args : dict, optional</span>
<span class="sd">            Messenger arguments, by default None</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the task, by default None</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Keyword arguments to pass on to the worker initialisation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OutputsType or list[OutputsType]</span>
<span class="sd">            The output interface of the task, or in the case of split tasks, a list of</span>
<span class="sd">            output interfaces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.submitter</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># noqa: F811</span>
            <span class="n">Submitter</span><span class="p">,</span>
            <span class="n">WORKER_KWARG_FAIL_NOTE</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Submitter</span><span class="p">(</span>
                <span class="n">audit_flags</span><span class="o">=</span><span class="n">audit_flags</span><span class="p">,</span>
                <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
                <span class="n">cache_locations</span><span class="o">=</span><span class="n">cache_locations</span><span class="p">,</span>
                <span class="n">messenger_args</span><span class="o">=</span><span class="n">messenger_args</span><span class="p">,</span>
                <span class="n">messengers</span><span class="o">=</span><span class="n">messengers</span><span class="p">,</span>
                <span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">,</span>
                <span class="n">environment</span><span class="o">=</span><span class="n">environment</span><span class="p">,</span>
                <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">sub</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;__notes__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">WORKER_KWARG_FAIL_NOTE</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">__notes__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">match</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;.*got an unexpected keyword argument &#39;(\w+)&#39;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Note that the unrecognised argument, </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">!r}</span><span class="s2">, is &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;an input of the task definition </span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> that has already been &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;parameterised (it is being called to execute it)&quot;</span>
                        <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">errored</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">WorkflowDef</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Workflow </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> failed with errors:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> failed @ </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;time of crash&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with following errors:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;error message&quot;</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">outputs</span>

<div class="viewcode-block" id="TaskDef.split"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskDef.split">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">splitter</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cont_dim</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this task parametrically over lists of split inputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        splitter : str or list[str] or tuple[str] or None</span>
<span class="sd">            the fields which to split over. If splitting over multiple fields, lists of</span>
<span class="sd">            fields are interpreted as outer-products and tuples inner-products. If None,</span>
<span class="sd">            then the fields to split are taken from the keyword-arg names.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            whether to overwrite an existing split on the node, by default False</span>
<span class="sd">        cont_dim : dict, optional</span>
<span class="sd">            Container dimensions for specific inputs, used in the splitter.</span>
<span class="sd">            If input name is not in cont_dim, it is assumed that the input values has</span>
<span class="sd">            a container dimension of 1, so only the most outer dim will be used for splitting.</span>
<span class="sd">        **inputs</span>
<span class="sd">            fields to split over, will be automatically wrapped in a StateArray object</span>
<span class="sd">            and passed to the node inputs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : TaskBase</span>
<span class="sd">            a reference to the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot overwrite existing splitter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;set &#39;overwrite=True&#39; to do so&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">splitter</span><span class="p">:</span>
            <span class="n">unwraped_split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hlpst</span><span class="o">.</span><span class="n">unwrap_splitter</span><span class="p">(</span><span class="n">splitter</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">duplicated</span> <span class="o">:=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">unwraped_split</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Splitter fields </span><span class="si">{</span><span class="n">duplicated</span><span class="si">}</span><span class="s2"> are duplicated&quot;</span><span class="p">)</span>
            <span class="n">split_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unwraped_split</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span>
            <span class="p">)</span>
            <span class="n">input_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_inputs</span> <span class="o">:=</span> <span class="nb">list</span><span class="p">(</span><span class="n">split_names</span> <span class="o">-</span> <span class="n">input_names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Splitter fields </span><span class="si">{</span><span class="n">missing_inputs</span><span class="si">}</span><span class="s2"> need to be provided as a keyword &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;arguments to the split method (provided </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">unrecognised_inputs</span> <span class="o">:=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_names</span> <span class="o">-</span> <span class="n">split_names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Provided inputs </span><span class="si">{</span><span class="n">unrecognised_inputs</span><span class="si">}</span><span class="s2"> are not present in the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;splitter </span><span class="si">{</span><span class="n">splitter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no splitter is provided, use the names of the inputs as combinatorial splitter</span>
            <span class="n">split_names</span> <span class="o">=</span> <span class="n">splitter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">cont_dim</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">split_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Container dimension for </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> is provided but the field &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is not present in the inputs&quot;</span>
                <span class="p">)</span>
        <span class="n">split_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lazy</span><span class="o">.</span><span class="n">LazyField</span><span class="p">):</span>
                <span class="n">split_val</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">splitter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">ty</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">split_val</span> <span class="o">=</span> <span class="n">StateArray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not split </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> as it is not a sequence type&quot;</span><span class="p">)</span>
            <span class="n">split_inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_val</span>
        <span class="n">split_def</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">split_inputs</span><span class="p">)</span>
        <span class="n">split_def</span><span class="o">.</span><span class="n">_splitter</span> <span class="o">=</span> <span class="n">splitter</span>
        <span class="n">split_def</span><span class="o">.</span><span class="n">_cont_dim</span> <span class="o">=</span> <span class="n">cont_dim</span>
        <span class="k">return</span> <span class="n">split_def</span></div>

<div class="viewcode-block" id="TaskDef.combine"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskDef.combine">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">combiner</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">ty</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine inputs parameterized by one or more previous tasks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        combiner : list[str] or str</span>
<span class="sd">            the field or list of inputs to be combined (i.e. not left split) after the</span>
<span class="sd">            task has been run</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            whether to overwrite an existing combiner on the node</span>
<span class="sd">        **kwargs : dict[str, Any]</span>
<span class="sd">            values for the task that will be &quot;combined&quot; before they are provided to the</span>
<span class="sd">            node</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : Self</span>
<span class="sd">            a reference to the outputs object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combiner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attempting to overwrite existing combiner </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_combiner</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;set &#39;overwrite=True&#39; to do so&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">combiner</span> <span class="o">=</span> <span class="p">[</span><span class="n">combiner</span><span class="p">]</span>
        <span class="n">local_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combiner</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">unrecognised</span> <span class="o">:=</span> <span class="n">local_names</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Combiner fields </span><span class="si">{</span><span class="n">unrecognised</span><span class="si">}</span><span class="s2"> are not present in the task definition&quot;</span>
            <span class="p">)</span>
        <span class="n">combined_def</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">combined_def</span><span class="o">.</span><span class="n">_combiner</span> <span class="o">=</span> <span class="n">combiner</span>
        <span class="k">return</span> <span class="n">combined_def</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate through all the names in the definition&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESERVED_FIELD_NAMES</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if two task definitions are equal&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_values</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other_values</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Return if attribute keys don&#39;t match</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">hash_eq</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">other_values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">other_values</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">values</span> <span class="o">!=</span> <span class="n">other_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">hash_cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hash_function</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">cache</span><span class="o">=</span><span class="n">hash_cache</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hash_function</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">cache</span><span class="o">=</span><span class="n">hash_cache</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_outputs</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">Outputs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">hash_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Outputs</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">hash_cache</span><span class="p">)</span> <span class="o">==</span> <span class="n">hash_function</span><span class="p">(</span>
            <span class="n">other_outputs</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">hash_cache</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the value for the given attribute, resolving any templates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            the name of the attribute to return</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            the value of the attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> doesn&#39;t have an attribute </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hsh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_hashes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hsh</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hash_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detects any changes in the hashed values between the current inputs and the</span>
<span class="sd">        previously calculated values&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_hashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_hashes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashes</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_hashes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a basic hash for any given set of fields.&quot;&quot;&quot;</span>
        <span class="n">inp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Out</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip output fields</span>
            <span class="c1"># removing values that are not set from hash calculation</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">attrs</span><span class="o">.</span><span class="n">NOTHING</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;container_path&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">inp_dict</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Include the outputs class, just in case any names or types have changed</span>
        <span class="n">inp_dict</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Outputs</span>
        <span class="n">hash_cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">()</span>
        <span class="n">field_hashes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">hash_cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">hash_function</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">field_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">field_hashes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_lazy_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">workflow_inputs</span><span class="p">:</span> <span class="s2">&quot;WorkflowDef&quot;</span><span class="p">,</span>
        <span class="n">graph</span><span class="p">:</span> <span class="s2">&quot;DiGraph[NodeExecution]&quot;</span><span class="p">,</span>
        <span class="n">state_index</span><span class="p">:</span> <span class="s2">&quot;StateIndex | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolves lazy fields in the task definition by replacing them with their</span>
<span class="sd">        actual values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        workflow : Workflow</span>
<span class="sd">            The workflow the task is part of</span>
<span class="sd">        graph : DiGraph[NodeExecution]</span>
<span class="sd">            The execution graph of the workflow</span>
<span class="sd">        state_index : StateIndex, optional</span>
<span class="sd">            The state index for the workflow, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Self</span>
<span class="sd">            The task definition with all lazy fields resolved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateIndex</span>

        <span class="k">if</span> <span class="n">state_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state_index</span> <span class="o">=</span> <span class="n">StateIndex</span><span class="p">()</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">LazyInField</span><span class="p">):</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">workflow_inputs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">LazyOutField</span><span class="p">):</span>
                <span class="n">resolved</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">state_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">resolved</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all rules are satisfied.&quot;&quot;&quot;</span>

        <span class="n">field</span><span class="p">:</span> <span class="n">Arg</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_lazy</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">attrs</span><span class="o">.</span><span class="n">NOTHING</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mandatory field </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> is not set&quot;</span><span class="p">)</span>

            <span class="c1"># Collect alternative fields associated with this field.</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">xor</span><span class="p">:</span>
                <span class="n">mutually_exclusive</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">xor</span><span class="p">}</span>
                <span class="n">are_set</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mutually_exclusive</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">are_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Mutually exclusive fields </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">xor</span><span class="si">}</span><span class="s2"> are set together: &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">are_set</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">mandatory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">are_set</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;At least one of the mutually exclusive fields </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">xor</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;should be set&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Raise error if any required field is unset.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">qualification</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot; at least one of the following requirements to be satisfied: &quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qualification</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> requires</span><span class="si">{</span><span class="n">qualification</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found the following errors in task </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> definition:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_arg_refs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Arg</span><span class="p">],</span> <span class="n">outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Out</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all fields referenced in requirements and xor are present in the inputs</span>
<span class="sd">        are valid field names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">Field</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">unrecognised</span> <span class="o">:=</span> <span class="p">(</span>
                <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span> <span class="o">-</span> <span class="n">input_names</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;Unrecognised&#39; field names in referenced in the requirements &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unrecognised</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">inpt</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">unrecognised</span> <span class="o">:=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inpt</span><span class="o">.</span><span class="n">xor</span><span class="p">)</span> <span class="o">-</span> <span class="n">input_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;Unrecognised&#39; field names in referenced in the xor &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of </span><span class="si">{</span><span class="n">inpt</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unrecognised</span><span class="p">))</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks that all the fields in the definition have been resolved&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lazy_values</span> <span class="o">:=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_lazy</span><span class="p">(</span><span class="n">v</span><span class="p">)]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot execute </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> because the following fields &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;still have lazy values </span><span class="si">{</span><span class="n">lazy_values</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Runtime"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.Runtime">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Runtime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent run time metadata.&quot;&quot;&quot;</span>

    <span class="n">rss_peak_gb</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Peak in consumption of physical RAM.&quot;&quot;&quot;</span>
    <span class="n">vms_peak_gb</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Peak in consumption of virtual memory.&quot;&quot;&quot;</span>
    <span class="n">cpu_peak_percent</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Peak in cpu consumption.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.Result">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Result</span><span class="p">(</span><span class="n">ty</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">OutputsType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metadata regarding the outputs of processing.&quot;&quot;&quot;</span>

    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="n">OutputsType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">runtime</span><span class="p">:</span> <span class="n">Runtime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">errored</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">definition</span><span class="p">:</span> <span class="n">TaskDef</span><span class="p">[</span><span class="n">OutputsType</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">CLOUD_PICKLE_ATTRS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="s2">&quot;definition&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOUD_PICKLE_ATTRS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOUD_PICKLE_ATTRS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<div class="viewcode-block" id="Result.get_output_field"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.Result.get_output_field">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used in get_values in Workflow</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_name : `str`</span>
<span class="sd">            Name of field in LazyField object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;all_&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errored</span><span class="p">:</span>
            <span class="n">error_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;_error.pklz&quot;</span>
            <span class="k">if</span> <span class="n">error_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RuntimeSpec"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.RuntimeSpec">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RuntimeSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specification for a task.</span>

<span class="sd">    From CWL::</span>

<span class="sd">        InlineJavascriptRequirement</span>
<span class="sd">        SchemaDefRequirement</span>
<span class="sd">        DockerRequirement</span>
<span class="sd">        SoftwareRequirement</span>
<span class="sd">        InitialWorkDirRequirement</span>
<span class="sd">        EnvVarRequirement</span>
<span class="sd">        ShellCommandRequirement</span>
<span class="sd">        ResourceRequirement</span>

<span class="sd">        InlineScriptRequirement</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outdir</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;shell&quot;</span>
    <span class="n">network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PythonOutputs"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.PythonOutputs">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PythonOutputs</span><span class="p">(</span><span class="n">TaskOutputs</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[PythonDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect the outputs of a task from a combination of the provided inputs,</span>
<span class="sd">        the objects in the output directory, and the stdout and stderr of the process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : Task[PythonDef]</span>
<span class="sd">            The task whose outputs are being collected.</span>
<span class="sd">        outputs_dict : dict[str, ty.Any]</span>
<span class="sd">            The outputs of the task, as a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs : Outputs</span>
<span class="sd">            The outputs of the task in dataclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_defaults</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span></div>


<span class="n">PythonOutputsType</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;OutputType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">PythonOutputs</span><span class="p">)</span>


<div class="viewcode-block" id="PythonDef"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.PythonDef">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PythonDef</span><span class="p">(</span><span class="n">TaskDef</span><span class="p">[</span><span class="n">PythonOutputsType</span><span class="p">]):</span>

    <span class="n">_task_type</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[PythonDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Prepare the inputs to the function</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span>
        <span class="c1"># Run the actual function</span>
        <span class="n">returned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="c1"># Collect the outputs and save them into the task.return_values dictionary</span>
        <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">default</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Outputs</span><span class="p">)}</span>
        <span class="n">return_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returned</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">nm</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">return_names</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if only one element in the fields, everything should be returned together</span>
            <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">returned</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">returned</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">return_names</span><span class="p">,</span> <span class="n">returned</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">returned</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">return_names</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">return_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements, but </span><span class="si">{</span><span class="n">returned</span><span class="si">}</span><span class="s2"> were returned&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="WorkflowOutputs"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.WorkflowOutputs">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WorkflowOutputs</span><span class="p">(</span><span class="n">TaskOutputs</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[WorkflowDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect the outputs of a workflow task from the outputs of the nodes in the</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : Task[WorfklowDef]</span>
<span class="sd">            The task whose outputs are being collected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs : Outputs</span>
<span class="sd">            The outputs of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_defaults</span><span class="p">()</span>
        <span class="c1"># collecting outputs from tasks</span>
        <span class="n">output_wf</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lazy_field</span><span class="p">:</span> <span class="n">lazy</span><span class="o">.</span><span class="n">LazyOutField</span>
        <span class="n">workflow</span><span class="p">:</span> <span class="s2">&quot;Workflow&quot;</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span>
        <span class="n">exec_graph</span><span class="p">:</span> <span class="s2">&quot;DiGraph[NodeExecution]&quot;</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">[</span><span class="s2">&quot;exec_graph&quot;</span><span class="p">]</span>
        <span class="n">nodes_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">exec_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lazy_field</span> <span class="ow">in</span> <span class="n">attrs_values</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val_out</span> <span class="o">=</span> <span class="n">lazy_field</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">exec_graph</span><span class="p">)</span>
                <span class="n">output_wf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_out</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">output_wf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">node</span><span class="p">:</span> <span class="s2">&quot;NodeExecution&quot;</span> <span class="o">=</span> <span class="n">nodes_dict</span><span class="p">[</span><span class="n">lazy_field</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="c1"># checking if the tasks has predecessors that raises error</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">errored</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tasks </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">_errored</span><span class="si">}</span><span class="s2"> raised an error&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err_files</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;_error.pklz&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">]</span>
                    <span class="n">err_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">err_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">err_files</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">lazy_field</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> raised an error, full crash report is &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;here: &quot;</span>
                        <span class="o">+</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">err_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">err_files</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="o">**</span><span class="n">output_wf</span><span class="p">)</span></div>


<span class="n">WorkflowOutputsType</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;OutputType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">WorkflowOutputs</span><span class="p">)</span>


<div class="viewcode-block" id="WorkflowDef"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.WorkflowDef">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WorkflowDef</span><span class="p">(</span><span class="n">TaskDef</span><span class="p">[</span><span class="n">WorkflowOutputsType</span><span class="p">]):</span>

    <span class="n">_task_type</span> <span class="o">=</span> <span class="s2">&quot;workflow&quot;</span>

    <span class="n">RESERVED_FIELD_NAMES</span> <span class="o">=</span> <span class="n">TaskDef</span><span class="o">.</span><span class="n">RESERVED_FIELD_NAMES</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;construct&quot;</span><span class="p">,)</span>

    <span class="n">_constructed</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[WorkflowDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the workflow.&quot;&quot;&quot;</span>
        <span class="n">task</span><span class="o">.</span><span class="n">submitter</span><span class="o">.</span><span class="n">expand_workflow</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[WorkflowDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the workflow asynchronously.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">task</span><span class="o">.</span><span class="n">submitter</span><span class="o">.</span><span class="n">expand_workflow_async</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<div class="viewcode-block" id="WorkflowDef.construct"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.WorkflowDef.construct">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Workflow&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.engine.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Workflow</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructed</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructed</span></div></div>


<span class="n">RETURN_CODE_HELP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;The process&#39; exit code.&quot;&quot;&quot;</span>
<span class="n">STDOUT_HELP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;The standard output stream produced by the command.&quot;&quot;&quot;</span>
<span class="n">STDERR_HELP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;The standard error stream produced by the command.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ShellOutputs"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.ShellOutputs">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ShellOutputs</span><span class="p">(</span><span class="n">TaskOutputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output definition of a generic shell process.&quot;&quot;&quot;</span>

    <span class="n">BASE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;return_code&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">]</span>

    <span class="n">return_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;return_code&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">RETURN_CODE_HELP</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">STDOUT_HELP</span><span class="p">)</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">STDERR_HELP</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[ShellDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect the outputs of a shell process from a combination of the provided inputs,</span>
<span class="sd">        the objects in the output directory, and the stdout and stderr of the process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputs : ShellDef</span>
<span class="sd">            The input definition of the shell process.</span>
<span class="sd">        output_dir : Path</span>
<span class="sd">            The directory where the process was run.</span>
<span class="sd">        stdout : str</span>
<span class="sd">            The standard output of the process.</span>
<span class="sd">        stderr : str</span>
<span class="sd">            The standard error of the process.</span>
<span class="sd">        return_code : int</span>
<span class="sd">            The exit code of the process.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs : ShellOutputs</span>
<span class="sd">            The outputs of the shell process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_defaults</span><span class="p">()</span>
        <span class="n">fld</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;return_code&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">]:</span>
                <span class="n">resolved_value</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># Get the corresponding value from the inputs if it exists, which will be</span>
            <span class="c1"># passed through to the outputs, to permit manual overrides</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">outarg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_set</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">resolved_value</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">is_set</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_resolve_default_value</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_resolve_value</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="c1"># Set the resolved value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">resolved_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_default_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fld</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve path and glob expr default values relative to the output dir&quot;&quot;&quot;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">default</span>
        <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">Path</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">default</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">all_files</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">all_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no file matches </span><span class="si">{</span><span class="n">default</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_required_fields_satisfied</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fld</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="s2">&quot;ShellDef&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;checking if all fields from the requires and template are set in the input</span>
<span class="sd">        if requires is a list of list, checking if at least one list has all elements set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fld</span><span class="o">.</span><span class="n">requires</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">requirements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RequirementSet</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">requires</span><span class="p">:</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">[</span><span class="n">RequirementSet</span><span class="p">()]</span>

        <span class="c1"># if the output has output_file_template field, add in all input fields from</span>
        <span class="c1"># the template to requires</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">outarg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fld</span><span class="o">.</span><span class="n">path_template</span><span class="p">:</span>
            <span class="c1"># if a template is a function it has to be run first with the inputs as the only arg</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">path_template</span><span class="p">):</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">path_template</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">inp_fields</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;{(\w+)(?:\:[^\}]+)?}&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">+=</span> <span class="n">inp_fields</span>

        <span class="c1"># Check to see if any of the requirement sets are satisfied</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">satisfied</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_value</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">fld</span><span class="p">:</span> <span class="s2">&quot;shell.out&quot;</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[DefType]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect output file if metadata specified.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pydra.design</span><span class="w"> </span><span class="kn">import</span> <span class="n">shell</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_required_fields_satisfied</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">definition</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">outarg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fld</span><span class="o">.</span><span class="n">path_template</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">template_update_single</span><span class="p">(</span>
                <span class="n">fld</span><span class="p">,</span>
                <span class="n">definition</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">spec_type</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">fld</span><span class="o">.</span><span class="n">callable</span><span class="p">:</span>
            <span class="n">callable_</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">callable</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">callable</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                <span class="c1"># In case callable is defined as a static method,</span>
                <span class="c1"># retrieve the function wrapped in the descriptor.</span>
                <span class="n">callable_</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">callable</span><span class="o">.</span><span class="vm">__func__</span>
            <span class="n">call_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">callable_</span><span class="p">)</span>
            <span class="n">call_args_val</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">argnm</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld</span>
                <span class="k">elif</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">output_dir</span>
                <span class="k">elif</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">inputs</span>
                <span class="k">elif</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;stdout&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">return_values</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;arguments of the callable function from </span><span class="si">{</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;has to be in inputs or be field or output_dir, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but </span><span class="si">{</span><span class="n">argnm</span><span class="si">}</span><span class="s2"> is used&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>
            <span class="k">return</span> <span class="n">callable_</span><span class="p">(</span><span class="o">**</span><span class="n">call_args_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Metadata for &#39;</span><span class="si">{</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, does not not contain any of the required fields &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;(&quot;callable&quot;, &quot;output_file_template&quot; or &quot;value&quot;): </span><span class="si">{</span><span class="n">fld</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="p">)</span></div>


<span class="n">ShellOutputsType</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;OutputType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">ShellOutputs</span><span class="p">)</span>


<div class="viewcode-block" id="ShellDef"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.ShellDef">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ShellDef</span><span class="p">(</span><span class="n">TaskDef</span><span class="p">[</span><span class="n">ShellOutputsType</span><span class="p">]):</span>

    <span class="n">_task_type</span> <span class="o">=</span> <span class="s2">&quot;shell&quot;</span>

    <span class="n">BASE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;additional_args&quot;</span><span class="p">]</span>

    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;additional_args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">attrs</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Additional free-form arguments to append to the end of the command.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">RESERVED_FIELD_NAMES</span> <span class="o">=</span> <span class="n">TaskDef</span><span class="o">.</span><span class="n">RESERVED_FIELD_NAMES</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;cmdline&quot;</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;Task[ShellDef]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the shell command.&quot;&quot;&quot;</span>
        <span class="n">task</span><span class="o">.</span><span class="n">return_values</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmdline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The equivalent command line that would be submitted if the task were run on</span>
<span class="sd">        the current working directory.&quot;&quot;&quot;</span>
        <span class="c1"># checking the inputs fields before returning the command line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_resolved</span><span class="p">()</span>
        <span class="c1"># Skip the executable, which can be a multi-part command, e.g. &#39;docker run&#39;.</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_args</span><span class="p">()</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd_args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="c1"># If there are spaces in the arg, and it is not enclosed by matching</span>
            <span class="c1"># quotes, add quotes to escape the space. Not sure if this should</span>
            <span class="c1"># be expanded to include other special characters apart from spaces</span>
            <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                <span class="n">cmdline</span> <span class="o">+=</span> <span class="s2">&quot; &#39;&quot;</span> <span class="o">+</span> <span class="n">arg</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmdline</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">arg</span>
        <span class="k">return</span> <span class="n">cmdline</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_command_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get command line arguments&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_resolved</span><span class="p">()</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">attrs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">modified_inputs</span> <span class="o">=</span> <span class="n">template_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_updates</span><span class="p">:</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_updates</span><span class="p">)</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">modified_inputs</span><span class="p">)</span>
        <span class="n">pos_args</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list for (position, command arg)</span>
        <span class="n">positions_provided</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;executable&quot;</span><span class="p">:</span>
                <span class="n">pos_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command_shelltask_executable</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;additional_args&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_pos_args</span><span class="p">(</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                    <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                    <span class="n">positions_provided</span><span class="o">=</span><span class="n">positions_provided</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">pos_val</span><span class="p">:</span>
                    <span class="n">pos_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_val</span><span class="p">)</span>

        <span class="c1"># Sort command and arguments by position</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="n">position_sort</span><span class="p">(</span><span class="n">pos_args</span><span class="p">)</span>
        <span class="c1"># pos_args values are each a list of arguments, so concatenate lists after sorting</span>
        <span class="n">command_args</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">command_args</span> <span class="o">+=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;additional_args&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">command_args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_command_shelltask_executable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returning position and value for executable ShellTask input&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># executable should be the first el. of the command</span>
        <span class="k">assert</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tuple2list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_command_shelltask_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returning position and value for args ShellTask input&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># assuming that args is the last el. of the command</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tuple2list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_command_pos_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">positions_provided</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">root</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking all additional input fields, setting pos to None, if position not set.</span>
<span class="sd">        Creating a list with additional parts of the command that comes from</span>
<span class="sd">        the specific field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">formatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># assuming that input that has no argstr is not used in the command,</span>
            <span class="c1"># or a formatter is not provided too.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;position should be an integer, but </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">position</span><span class="si">}</span><span class="s2"> given&quot;</span>
                <span class="p">)</span>
            <span class="c1"># checking if the position is not already used</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">position</span> <span class="ow">in</span> <span class="n">positions_provided</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> can&#39;t have provided position, </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">position</span><span class="si">}</span><span class="s2"> is already used&quot;</span>
                <span class="p">)</span>

            <span class="n">positions_provided</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">root</span><span class="p">:</span>  <span class="c1"># values from templates</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is read only, the value can&#39;t be provided&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">formatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">cmd_add</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># formatter that creates a custom command argument</span>
        <span class="c1"># it can take the value of the field, all inputs, or the value of other fields.</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">formatter</span><span class="p">:</span>
            <span class="n">call_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">call_args_val</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">argnm</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="n">argnm</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
                    <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">argnm</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                        <span class="n">call_args_val</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">argnm</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;arguments of the formatter function from </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;has to be in inputs or be field or output_dir, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but </span><span class="si">{</span><span class="n">argnm</span><span class="si">}</span><span class="s2"> is used&quot;</span>
                        <span class="p">)</span>
            <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">formatter</span><span class="p">(</span><span class="o">**</span><span class="n">call_args_val</span><span class="p">)</span>
            <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">cmd_el_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd_el_str</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">cmd_add</span> <span class="o">+=</span> <span class="n">split_cmd</span><span class="p">(</span><span class="n">cmd_el_str</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="ow">and</span> <span class="s2">&quot;{&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="p">:</span>
            <span class="c1"># if value is simply True the original argstr is used,</span>
            <span class="c1"># if False, nothing is added to the command.</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cmd_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ty</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MultiInputObj</span><span class="p">:</span>
            <span class="c1"># if the field is MultiInputObj, it is used to create a list of arguments</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">cmd_add</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_arg</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_add</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_arg</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">cmd_add</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">shell</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returning arguments used to specify the command args for a single inputs&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="n">field</span><span class="o">.</span><span class="n">argstr</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># if argstr has a more complex form, with &quot;{input_field}&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span> <span class="ow">and</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="p">:</span>
                <span class="n">argstr_formatted_l</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">argstr_f</span> <span class="o">=</span> <span class="n">argstr_formatting</span><span class="p">(</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value_updates</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">argstr_formatted_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">argstr_f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argstr_formatted_l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># argstr has a simple form, e.g. &quot;-f&quot;, or &quot;--f&quot;</span>
                <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># in case there are ... when input is not a list</span>
            <span class="n">field</span><span class="o">.</span><span class="n">argstr</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">cmd_el_str</span>
            <span class="c1"># if argstr has a more complex form, with &quot;{input_field}&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span> <span class="ow">and</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="p">:</span>
                <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="n">argstr_formatting</span><span class="p">(</span><span class="n">cmd_el_str</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># argstr has a simple form, e.g. &quot;-f&quot;, or &quot;--f&quot;</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">argstr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmd_el_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">split_cmd</span><span class="p">(</span><span class="n">cmd_el_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_bindings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return bindings necessary to run task in an alternative root.</span>

<span class="sd">        This is primarily intended for contexts when a task is going</span>
<span class="sd">        to be run in a container with mounted volumes.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        root: str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bindings: dict</span>
<span class="sd">          Mapping from paths in the host environment to the target environment</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_bindings</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_bindings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare input files to be passed to the task</span>

<span class="sd">        This updates the ``bindings`` attribute of the current task to make files available</span>
<span class="sd">        in an ``Environment``-defined ``root``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fld</span><span class="p">:</span> <span class="n">Arg</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">attrs_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">TypeParser</span><span class="o">.</span><span class="n">contains_type</span><span class="p">(</span><span class="n">FileSet</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                <span class="n">fileset</span><span class="p">:</span> <span class="n">FileSet</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">FileSet</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s2">&quot;Generating environment bindings for nested FileSets are not &quot;</span>
                        <span class="s2">&quot;yet supported&quot;</span>
                    <span class="p">)</span>
                <span class="n">copy</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">copy_mode</span> <span class="o">==</span> <span class="n">FileSet</span><span class="o">.</span><span class="n">CopyMode</span><span class="o">.</span><span class="n">copy</span>

                <span class="n">host_path</span><span class="p">,</span> <span class="n">env_path</span> <span class="o">=</span> <span class="n">fileset</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}{</span><span class="n">fileset</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Default to mounting paths as read-only, but respect existing modes</span>
                <span class="n">old_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host_path</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">[</span><span class="n">host_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">env_path</span><span class="p">,</span> <span class="s2">&quot;rw&quot;</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">old_mode</span><span class="p">)</span>

                <span class="c1"># Provide in-container paths without type-checking</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_mod_root</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">env_path</span> <span class="o">/</span> <span class="n">rel</span> <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">fileset</span><span class="o">.</span><span class="n">relative_fspaths</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generated_output_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of all outputs that will be generated by the task.</span>
<span class="sd">        Takes into account the task input and the requires list for the output fields.</span>
<span class="sd">        TODO: should be in all Output specs?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># checking the input (if all mandatory fields are provided, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_rules</span><span class="p">()</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;return_code&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># assuming that field should have either default or metadata, but not both</span>
            <span class="k">if</span> <span class="n">is_set</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                <span class="n">output_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">is_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Outputs</span><span class="o">.</span><span class="n">_resolve_output_value</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)):</span>
                <span class="n">output_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_names</span>

    <span class="n">DEFAULT_COPY_COLLATION</span> <span class="o">=</span> <span class="n">FileSet</span><span class="o">.</span><span class="n">CopyCollation</span><span class="o">.</span><span class="n">adjacent</span></div>


<div class="viewcode-block" id="donothing"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.donothing">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">donothing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TaskHook"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskHook">[docs]</a><span class="nd">@attrs</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TaskHook</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callable task hooks.&quot;&quot;&quot;</span>

    <span class="n">pre_run_task</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="n">donothing</span>
    <span class="n">post_run_task</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="n">donothing</span>
    <span class="n">pre_run</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="n">donothing</span>
    <span class="n">post_run</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="n">donothing</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pre_run_task&quot;</span><span class="p">,</span> <span class="s2">&quot;post_run_task&quot;</span><span class="p">,</span> <span class="s2">&quot;pre_run&quot;</span><span class="p">,</span> <span class="s2">&quot;post_run&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot set unknown hook&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<div class="viewcode-block" id="TaskHook.reset"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.TaskHook.reset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pre_run_task&quot;</span><span class="p">,</span> <span class="s2">&quot;post_run_task&quot;</span><span class="p">,</span> <span class="s2">&quot;pre_run&quot;</span><span class="p">,</span> <span class="s2">&quot;post_run&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">donothing</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="split_cmd"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.split_cmd">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">split_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits a shell command line into separate arguments respecting quotes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmd : str</span>
<span class="sd">        Command line string or part thereof</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        the command line string split into process args</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Check whether running on posix or Windows system</span>
    <span class="n">on_posix</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="n">on_posix</span><span class="p">)</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;([&#39;</span><span class="se">\&quot;</span><span class="s2">])(.*)</span><span class="se">\\</span><span class="s2">1$&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">cmd_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd_args</span></div>


<div class="viewcode-block" id="argstr_formatting"><a class="viewcode-back" href="../../../reference/api.html#pydra.engine.specs.argstr_formatting">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">argstr_formatting</span><span class="p">(</span>
    <span class="n">argstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="n">value_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;formatting argstr that have form {field_name},</span>
<span class="sd">    using values from inputs and updating with value_update if provided</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if there is a value that has to be updated (e.g. single value from a list)</span>
    <span class="c1"># getting all fields that should be formatted, i.e. {field_name}, ...</span>
    <span class="k">if</span> <span class="n">value_updates</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value_updates</span><span class="p">)</span>
    <span class="n">inp_fields</span> <span class="o">=</span> <span class="n">parse_format_string</span><span class="p">(</span><span class="n">argstr</span><span class="p">)</span>
    <span class="n">val_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fld_name</span> <span class="ow">in</span> <span class="n">inp_fields</span><span class="p">:</span>
        <span class="n">fld_value</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">fld_name</span><span class="p">]</span>
        <span class="n">fld_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)),</span> <span class="n">fld_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fld_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">fld_value</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="ow">and</span> <span class="n">fld_attr</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span>
            <span class="ow">and</span> <span class="n">TypeParser</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">fld_attr</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">bool</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="c1"># if value is NOTHING, nothing should be added to the command</span>
            <span class="n">val_dict</span><span class="p">[</span><span class="n">fld_name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_dict</span><span class="p">[</span><span class="n">fld_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld_value</span>

    <span class="c1"># formatting string based on the val_dict</span>
    <span class="n">argstr_formatted</span> <span class="o">=</span> <span class="n">argstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">val_dict</span><span class="p">)</span>
    <span class="c1"># removing extra commas and spaces after removing the field that have NOTHING</span>
    <span class="n">argstr_formatted</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">argstr_formatted</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[ &quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; ]&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[,&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,]&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">argstr_formatted</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Nipype developers
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>